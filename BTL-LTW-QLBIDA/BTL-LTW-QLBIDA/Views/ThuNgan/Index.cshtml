@{
    ViewData["Title"] = "Thu Ngân";
    Layout = "~/Views/Shared/_LayoutFullWidth.cshtml"; // ← Dùng layout mới
}
<link rel="icon" type="image/x-icon" href="~/logo.png" />
@section Styles {
    <link rel="stylesheet" href="~/css/thungan.css" />
    <style>
        /* ===========================
                   CHỈ ÁP DỤNG KHI CÓ CLASS .page-thungan-fullscreen
                =========================== */
        html.page-thungan-fullscreen {
            overflow: hidden !important;
            height: 100%;
        }

        body.page-thungan-fullscreen {
            overflow: hidden !important;
            height: 100%;
            margin: 0;
            padding: 0;
        }

            /* Main fullscreen */
            body.page-thungan-fullscreen main {
                height: calc(100vh - 60px);
                overflow: hidden;
                padding: 0 !important;
                margin: 0 !important;
            }

            body.page-thungan-fullscreen .thungan-container {
                height: 100%;
            }

        /* ===========================
                   RESPONSIVE WARNING
                =========================== */
        #responsiveWarning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .warning-content {
            text-align: center;
            color: white;
            max-width: 500px;
        }

        .warning-icon {
            width: 150px;
            height: 150px;
            background: white;
            border-radius: 30px;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .warning-stars {
            font-size: 30px;
            margin: 20px 0;
            letter-spacing: 5px;
        }

        .warning-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .warning-message {
            font-size: 16px;
            opacity: 0.95;
            line-height: 1.6;
        }

        /* Responsive - Hiện cảnh báo khi < 1152px */
        @@media (max-width: 1152px) {
            body.page-thungan-fullscreen #responsiveWarning {
                display: flex !important;
            }

            body.page-thungan-fullscreen .thungan-container {
                display: none !important;
            }
        }

        @@media (max-width: 768px) {
            .warning-icon {
                width: 120px;
                height: 120px;
            }

            .warning-stars {
                font-size: 24px;
            }

            .warning-title {
                font-size: 20px;
            }

            .warning-message {
                font-size: 14px;
            }
        }
    </style>
}


<!-- ===========================
     CẢNH BÁO MÀN HÌNH NHỎ
=========================== -->
<div id="responsiveWarning">
    <div class="warning-content">
        <div class="warning-icon">
            <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <!-- Chef Hat -->
                <ellipse cx="100" cy="140" rx="50" ry="15" fill="#E8F4F8" />
                <rect x="60" y="80" width="80" height="60" rx="5" fill="#FFFFFF" />
                <ellipse cx="100" cy="70" rx="45" ry="40" fill="#FFFFFF" />

                <!-- Face -->
                <circle cx="100" cy="120" r="35" fill="#FFD4A3" />

                <!-- Hair -->
                <path d="M 70 95 Q 70 85, 80 85 Q 85 80, 90 85 Q 95 80, 100 85 Q 105 80, 110 85 Q 115 80, 120 85 Q 125 85, 130 95" fill="#8B4513" />

                <!-- Eyes -->
                <circle cx="90" cy="115" r="3" fill="#000" />
                <circle cx="110" cy="115" r="3" fill="#000" />

                <!-- Smile -->
                <path d="M 85 125 Q 100 135, 115 125" stroke="#000" stroke-width="2" fill="none" stroke-linecap="round" />

                <!-- Plate with Coffee -->
                <ellipse cx="145" cy="135" rx="20" ry="8" fill="#E0E0E0" />
                <rect x="140" y="120" width="10" height="15" rx="2" fill="#8B4513" />
                <ellipse cx="145" cy="120" rx="6" ry="3" fill="#5D4037" />

                <!-- Steam -->
                <path d="M 140 110 Q 135 105, 140 100" stroke="#AAA" stroke-width="1.5" fill="none" opacity="0.6" />
                <path d="M 145 108 Q 140 103, 145 98" stroke="#AAA" stroke-width="1.5" fill="none" opacity="0.6" />
                <path d="M 150 110 Q 155 105, 150 100" stroke="#AAA" stroke-width="1.5" fill="none" opacity="0.6" />
            </svg>
        </div>

        <div class="warning-stars">⭐⭐⭐⭐⭐</div>

        <h1 class="warning-title">
            Sử dụng App Anh Dũng Hiển Nghĩa Trình<br>
            Nhân viên Nhà hàng
        </h1>

        <p class="warning-message">
            Để thực hiện thao tác bán hàng linh hoạt hơn<br>
            và dễ dàng hơn trên thiết bị này
        </p>
    </div>
</div>

<div class="thungan-container">
    <!-- BÊN TRÁI: Danh sách bàn / Thực đơn -->
    <div class="thungan-left">
        <!-- Header Tabs -->
        <div class="thungan-header">
            <button id="btnShowBan" class="tab-btn active">
                <i class="bi bi-grid-3x3"></i> Phòng bàn
            </button>
            <button id="btnShowDichVu" class="tab-btn">
                <i class="bi bi-cup-straw"></i> Thực đơn
            </button>
        </div>


        <!-- Tabs Khu vực / Loại dịch vụ -->
        <div class="thungan-tabs">
            <!-- ============================================
                 TABS KHU VỰC (Giữ nguyên)
                 ============================================ -->
            <div id="tabsKhuVuc" class="tabs-container-inline">
                @{
                    var khuVucs = ViewBag.KhuVucs as List<BTL_LTW_QLBIDA.Models.Khuvuc>;
                    int maxVisible = 7; // Số tabs hiển thị tối đa (bao gồm cả "Tất cả")
                    int visibleCount = khuVucs != null ? Math.Min(maxVisible - 1, khuVucs.Count) : 0;
                }

                <!-- Tab "Tất cả" luôn hiển thị -->
                <button class="filter-btn active" data-khu="">Tất cả</button>

                <!-- Hiển thị các khu vực đầu tiên -->
                @if (khuVucs != null)
                {
                    for (int i = 0; i < visibleCount; i++)
                    {
                        <button class="filter-btn" data-khu="@khuVucs[i].Idkhu">@khuVucs[i].Tenkhu</button>
                    }
                }

                <!-- Dropdown chỉ hiện khi có nhiều khu vực hơn -->
                @if (khuVucs != null && khuVucs.Count > visibleCount)
                {
                    <div class="khuvuc-dropdown-inline">
                        <button class="filter-btn dropdown-toggle-inline" id="dropdownMoreKhuVuc">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu-inline" id="menuMoreKhuVuc">
                            @for (int i = visibleCount; i < khuVucs.Count; i++)
                            {
                                <button class="dropdown-item-inline" data-khu="@khuVucs[i].Idkhu">
                                    @khuVucs[i].Tenkhu
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Tabs Loại dịch vụ -->
            <!-- ============================================
                 TABS LOẠI DỊCH VỤ (MỚI - TƯƠNG TỰ KHU VỰC)
                 ============================================ -->
            <div id="tabsLoaiDv" class="tabs-container-inline" style="display: none;">
                @{
                    var loaiDichVus = ViewBag.LoaiDichVus as List<BTL_LTW_QLBIDA.Models.Loaidichvu>;
                    int maxVisibleLoaiDv = 7; // Số tabs loại DV hiển thị tối đa (bao gồm "Tất cả")
                    int visibleCountLoaiDv = loaiDichVus != null ? Math.Min(maxVisibleLoaiDv - 1, loaiDichVus.Count) : 0;
                }
                <!-- Tab "Tất cả" luôn hiển thị -->
                <button class="filter-btn active" data-loai="">Tất cả</button>
                <!-- Hiển thị các loại dịch vụ đầu tiên -->
                @if (loaiDichVus != null)
                {
                    for (int i = 0; i < visibleCountLoaiDv; i++)
                    {
                        // Icon cho từng loại
                        var icon = "";
                        if (loaiDichVus[i].Idloai == "LDV001") icon = "🥤";
                        else if (loaiDichVus[i].Idloai == "LDV002") icon = "🍔";
                        else if (loaiDichVus[i].Idloai == "LDV003") icon = "📦";

                        <button class="filter-btn" data-loai="@loaiDichVus[i].Idloai">
                            @icon @loaiDichVus[i].Tenloai
                        </button>
                    }
                }
                <!-- Dropdown cho loại dịch vụ còn lại -->
                @if (loaiDichVus != null && loaiDichVus.Count > visibleCountLoaiDv)
                {
                    <div class="loaidv-dropdown-inline">
                        <button class="filter-btn dropdown-toggle-inline" id="dropdownMoreLoaiDv">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu-inline" id="menuMoreLoaiDv">
                            @for (int i = visibleCountLoaiDv; i < loaiDichVus.Count; i++)
                            {
                                var icon = "";
                                if (loaiDichVus[i].Idloai == "LDV001") icon = "🥤";
                                else if (loaiDichVus[i].Idloai == "LDV002") icon = "🍔";
                                else if (loaiDichVus[i].Idloai == "LDV003") icon = "📦";

                                <button class="dropdown-item-inline" data-loai="@loaiDichVus[i].Idloai">
                                    @icon @loaiDichVus[i].Tenloai
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Nội dung động -->
        <div id="contentArea" class="content-area">
            <!-- Partial View sẽ load vào đây -->
        </div>
    </div>

    <!-- BÊN PHẢI: Hóa đơn chi tiết -->
    <div class="thungan-right">
        <div class="hoadon-header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-receipt"></i>
                    <span id="tenBanHienTai">Chưa chọn bàn</span>
                </div>

                <!-- Thanh tìm kiếm khách hàng mới -->
                <div class="customer-search-container">
                    <!-- State 1: Chưa chọn khách hàng - Hiện search -->
                    <div id="customerSearchBox" class="customer-search-box">
                        <i class="bi bi-search"></i>
                        <input type="text"
                               id="searchKhachHang"
                               placeholder="Tìm khách hàng (F4)"
                               autocomplete="off">
                        <button type="button" class="btn-add-icon" onclick="moModalThemKhachHang('')" title="Thêm khách hàng mới">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>

                    <!-- State 2: Đã chọn khách hàng - Hiện badge -->
                    <div id="customerSelectedBox" class="customer-selected-box" style="display: none;">
                        <i class="bi bi-person-circle"></i>
                        <span id="selectedCustomerName">Nguyễn Văn A</span>
                        <button type="button" class="btn-remove-icon" onclick="xoaKhachHang()" title="Bỏ khách hàng">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>

                    <!-- Dropdown kết quả -->
                    <div id="searchResults" class="search-results-dropdown"></div>
                </div>
            </div>
        </div>

        <div id="hoaDonArea" class="hoadon-area">
            <div class="empty-state">
                <i class="bi bi-cart-x"></i>
                <p>Vui lòng chọn bàn</p>
            </div>
        </div>
    </div>
</div>

<!-- ✅ THÊM: Hidden inputs cho thông tin nhân viên -->
<input type="hidden" id="tenNhanVien" value="@ViewBag.TenNhanVien" />
<input type="hidden" id="idNhanVien" value="@ViewBag.IdNhanVien" />

<!-- Modal thanh toán - Chỉ load 1 lần -->
@await Html.PartialAsync("~/Views/Shared/ThuNgan/_ModalThanhToan.cshtml")

<!-- MODAL XÁC NHẬN THANH TOÁN -->
<div class="modal fade" id="modalXacNhanThanhToan" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header" style="background: #A250B2; color: white; border: none;">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill"></i> Xác nhận
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div style="font-size: 64px; color: #A250B2; margin-bottom: 16px;">
                    <i class="bi bi-question-circle"></i>
                </div>
                <h6 style="font-weight: 600; color: #1f2937; line-height: 1.6;">
                    Bạn có chắc muốn<br>
                    <strong style="color: #A250B2;">dừng tính giờ và thanh toán</strong><br>
                    không?
                </h6>
            </div>
            <div class="modal-footer" style="border: none; padding: 0 20px 20px 20px;">
                <button type="button" class="btn btn-secondary w-100 mb-2" data-bs-dismiss="modal" style="border-radius: 8px; padding: 10px;">
                    <i class="bi bi-x-circle"></i> Không
                </button>
                <button type="button" class="btn btn-primary w-100" id="btnDongYThanhToan" style="background: #A250B2; border-color: #A250B2; border-radius: 8px; padding: 10px;">
                    <i class="bi bi-check-circle"></i> Có, thanh toán
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ← THÊM: Modal preview PDF -->
@await Html.PartialAsync("~/Views/Shared/ThuNgan/_ModalPreviewPdf.cshtml")

<!-- Include Modal Thêm Khách Hàng -->
@await Html.PartialAsync("ThuNgan/_ModalThemKhachHang")

@section Scripts {
    <script src="~/js/thungan.js"></script>

    <script>
        $(document).ready(function() {
            // ✅ Thêm class vào html và body khi vào trang Thu Ngân
            $('html').addClass('page-thungan-fullscreen');
            $('body').addClass('page-thungan-fullscreen');

            console.log('✅ Đã thêm class fullscreen cho trang Thu Ngân');
        });

        // ✅ Xóa class khi rời khỏi trang (tùy chọn)
        $(window).on('beforeunload', function() {
            $('html').removeClass('page-thungan-fullscreen');
            $('body').removeClass('page-thungan-fullscreen');
        });
    </script>
}