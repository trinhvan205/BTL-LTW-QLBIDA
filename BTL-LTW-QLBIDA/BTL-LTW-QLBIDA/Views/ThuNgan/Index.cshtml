@{
    ViewData["Title"] = "Thu Ngân";
    Layout = "~/Views/Shared/_LayoutFullWidth.cshtml"; // ← Dùng layout mới
}

@section Styles {
    <link rel="stylesheet" href="~/css/thungan.css" />
}

<div class="thungan-container">
    <!-- BÊN TRÁI: Danh sách bàn / Thực đơn -->
    <div class="thungan-left">
        <!-- Header Tabs -->
        <div class="thungan-header">
            <button id="btnShowBan" class="tab-btn active">
                <i class="bi bi-grid-3x3"></i> Phòng bàn
            </button>
            <button id="btnShowDichVu" class="tab-btn">
                <i class="bi bi-cup-straw"></i> Thực đơn
            </button>
        </div>


        <!-- Tabs Khu vực / Loại dịch vụ -->
        <div class="thungan-tabs">
            <!-- ============================================
                 TABS KHU VỰC (Giữ nguyên)
                 ============================================ -->
            <div id="tabsKhuVuc" class="tabs-container-inline">
                @{
                    var khuVucs = ViewBag.KhuVucs as List<BTL_LTW_QLBIDA.Models.Khuvuc>;
                    int maxVisible = 7; // Số tabs hiển thị tối đa (bao gồm cả "Tất cả")
                    int visibleCount = khuVucs != null ? Math.Min(maxVisible - 1, khuVucs.Count) : 0;
                }

                <!-- Tab "Tất cả" luôn hiển thị -->
                <button class="filter-btn active" data-khu="">Tất cả</button>

                <!-- Hiển thị các khu vực đầu tiên -->
                @if (khuVucs != null)
                {
                    for (int i = 0; i < visibleCount; i++)
                    {
                        <button class="filter-btn" data-khu="@khuVucs[i].Idkhu">@khuVucs[i].Tenkhu</button>
                    }
                }

                <!-- Dropdown chỉ hiện khi có nhiều khu vực hơn -->
                @if (khuVucs != null && khuVucs.Count > visibleCount)
                {
                    <div class="khuvuc-dropdown-inline">
                        <button class="filter-btn dropdown-toggle-inline" id="dropdownMoreKhuVuc">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu-inline" id="menuMoreKhuVuc">
                            @for (int i = visibleCount; i < khuVucs.Count; i++)
                            {
                                <button class="dropdown-item-inline" data-khu="@khuVucs[i].Idkhu">
                                    @khuVucs[i].Tenkhu
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Tabs Loại dịch vụ -->
            <!-- ============================================
                 TABS LOẠI DỊCH VỤ (MỚI - TƯƠNG TỰ KHU VỰC)
                 ============================================ -->
            <div id="tabsLoaiDv" class="tabs-container-inline" style="display: none;">
                @{
                    var loaiDichVus = ViewBag.LoaiDichVus as List<BTL_LTW_QLBIDA.Models.Loaidichvu>;
                    int maxVisibleLoaiDv = 7; // Số tabs loại DV hiển thị tối đa (bao gồm "Tất cả")
                    int visibleCountLoaiDv = loaiDichVus != null ? Math.Min(maxVisibleLoaiDv - 1, loaiDichVus.Count) : 0;
                }
                <!-- Tab "Tất cả" luôn hiển thị -->
                <button class="filter-btn active" data-loai="">Tất cả</button>
                <!-- Hiển thị các loại dịch vụ đầu tiên -->
                @if (loaiDichVus != null)
                {
                    for (int i = 0; i < visibleCountLoaiDv; i++)
                    {
                        // Icon cho từng loại
                        var icon = "";
                        if (loaiDichVus[i].Idloai == "LDV001") icon = "🥤";
                        else if (loaiDichVus[i].Idloai == "LDV002") icon = "🍔";
                        else if (loaiDichVus[i].Idloai == "LDV003") icon = "📦";

                        <button class="filter-btn" data-loai="@loaiDichVus[i].Idloai">
                            @icon @loaiDichVus[i].Tenloai
                        </button>
                    }
                }
                <!-- Dropdown cho loại dịch vụ còn lại -->
                @if (loaiDichVus != null && loaiDichVus.Count > visibleCountLoaiDv)
                {
                    <div class="loaidv-dropdown-inline">
                        <button class="filter-btn dropdown-toggle-inline" id="dropdownMoreLoaiDv">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu-inline" id="menuMoreLoaiDv">
                            @for (int i = visibleCountLoaiDv; i < loaiDichVus.Count; i++)
                            {
                                var icon = "";
                                if (loaiDichVus[i].Idloai == "LDV001") icon = "🥤";
                                else if (loaiDichVus[i].Idloai == "LDV002") icon = "🍔";
                                else if (loaiDichVus[i].Idloai == "LDV003") icon = "📦";

                                <button class="dropdown-item-inline" data-loai="@loaiDichVus[i].Idloai">
                                    @icon @loaiDichVus[i].Tenloai
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Nội dung động -->
        <div id="contentArea" class="content-area">
            <!-- Partial View sẽ load vào đây -->
        </div>
    </div>

    <!-- BÊN PHẢI: Hóa đơn chi tiết -->
    <div class="thungan-right">
        <div class="hoadon-header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-receipt"></i>
                    <span id="tenBanHienTai">Chưa chọn bàn</span>
                </div>

                <!-- Thanh tìm kiếm khách hàng mới -->
                <div class="customer-search-container">
                    <!-- State 1: Chưa chọn khách hàng - Hiện search -->
                    <div id="customerSearchBox" class="customer-search-box">
                        <i class="bi bi-search"></i>
                        <input type="text"
                               id="searchKhachHang"
                               placeholder="Tìm khách hàng (F4)"
                               autocomplete="off">
                        <button type="button" class="btn-add-icon" onclick="moModalThemKhachHang('')" title="Thêm khách hàng mới">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>

                    <!-- State 2: Đã chọn khách hàng - Hiện badge -->
                    <div id="customerSelectedBox" class="customer-selected-box" style="display: none;">
                        <i class="bi bi-person-circle"></i>
                        <span id="selectedCustomerName">Nguyễn Văn A</span>
                        <button type="button" class="btn-remove-icon" onclick="xoaKhachHang()" title="Bỏ khách hàng">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>

                    <!-- Dropdown kết quả -->
                    <div id="searchResults" class="search-results-dropdown"></div>
                </div>
            </div>
        </div>

        <div id="hoaDonArea" class="hoadon-area">
            <div class="empty-state">
                <i class="bi bi-cart-x"></i>
                <p>Vui lòng chọn bàn</p>
            </div>
        </div>
    </div>
</div>

<!-- ✅ THÊM: Hidden inputs cho thông tin nhân viên -->
<input type="hidden" id="tenNhanVien" value="@ViewBag.TenNhanVien" />
<input type="hidden" id="idNhanVien" value="@ViewBag.IdNhanVien" />

<!-- Modal thanh toán - Chỉ load 1 lần -->
@await Html.PartialAsync("~/Views/Shared/ThuNgan/_ModalThanhToan.cshtml")

<!-- MODAL XÁC NHẬN THANH TOÁN -->
<div class="modal fade" id="modalXacNhanThanhToan" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header" style="background: #A250B2; color: white; border: none;">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill"></i> Xác nhận
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div style="font-size: 64px; color: #A250B2; margin-bottom: 16px;">
                    <i class="bi bi-question-circle"></i>
                </div>
                <h6 style="font-weight: 600; color: #1f2937; line-height: 1.6;">
                    Bạn có chắc muốn<br>
                    <strong style="color: #A250B2;">dừng tính giờ và thanh toán</strong><br>
                    không?
                </h6>
            </div>
            <div class="modal-footer" style="border: none; padding: 0 20px 20px 20px;">
                <button type="button" class="btn btn-secondary w-100 mb-2" data-bs-dismiss="modal" style="border-radius: 8px; padding: 10px;">
                    <i class="bi bi-x-circle"></i> Không
                </button>
                <button type="button" class="btn btn-primary w-100" id="btnDongYThanhToan" style="background: #A250B2; border-color: #A250B2; border-radius: 8px; padding: 10px;">
                    <i class="bi bi-check-circle"></i> Có, thanh toán
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ← THÊM: Modal preview PDF -->
@await Html.PartialAsync("~/Views/Shared/ThuNgan/_ModalPreviewPdf.cshtml")

<!-- Include Modal Thêm Khách Hàng -->
@await Html.PartialAsync("ThuNgan/_ModalThemKhachHang")

@section Scripts {
    <script src="~/js/thungan.js"></script>
}