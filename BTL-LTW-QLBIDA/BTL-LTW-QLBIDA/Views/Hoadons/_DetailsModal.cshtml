@model BTL_LTW_QLBIDA.Models.Hoadon

@{
    DateTime? vao = Model.IdphienNavigation?.Giobatdau;
    DateTime? ra = Model.IdphienNavigation?.Gioketthuc;

    double gioChoi = 0;
    if (vao != null && ra != null)
    {
        gioChoi = (ra.Value - vao.Value).TotalHours;
        gioChoi = Math.Round(gioChoi, 2);
    }

    decimal giaBan = Model.IdphienNavigation?.IdbanNavigation?.Giatien ?? 0;
    decimal tienGio = (decimal)gioChoi * giaBan;

    decimal tongDv = 0;
    foreach (var dv in Model.Hoadondvs)
    {
        tongDv += (dv.IddvNavigation?.Giatien ?? 0) * (dv.Soluong ?? 0);
    }

    decimal tongCong = tienGio + tongDv;
}

<div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
        <i class="bi bi-receipt me-2"></i> Chi tiết hóa đơn @Model.Idhd
    </h5>
    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">

    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-primary btn-print-detail" data-id="@Model.Idhd">
            <i class="bi bi-printer"></i> In hóa đơn
        </button>
    </div>

    <!-- THÔNG TIN CHUNG -->
    <div class="card mb-3 shadow-sm border-0">
        <div class="card-header bg-light fw-bold text-primary">
            <i class="bi bi-info-circle me-1"></i> Thông tin chung
        </div>

        <div class="card-body">

            <div class="row mb-2">
                <div class="col-md-6">
                    <p><strong>Khách hàng:</strong> @Model.IdkhNavigation?.Hoten</p>
                    <p><strong>Nhân viên lập HĐ:</strong> @Model.IdnvNavigation?.Hotennv</p>
                    <p>
                        <strong>Phương thức thanh toán:</strong>
                        <span class="badge bg-info text-dark px-3">@Model.IdptttNavigation?.Tenpttt</span>
                    </p>
                </div>

                <div class="col-md-6">
                    <p><strong>Ngày lập:</strong> @Model.Ngaylap?.ToString("dd/MM/yyyy HH:mm")</p>

                    <p><strong>Bàn chơi:</strong> @Model.IdphienNavigation?.Idban</p>

                    <p>
                        <strong>Giờ vào – Giờ ra:</strong><br />
                        @(vao?.ToString("HH:mm") ?? "--") → @(ra?.ToString("HH:mm") ?? "--")
                    </p>

                    <p>
                        <strong>Thời gian chơi:</strong>
                        @{
                            if (gioChoi > 0)
                            {
                                var h = Math.Floor(gioChoi);
                                var m = Math.Round((gioChoi - h) * 60);
                                @($"{h}h {m}p")
                            }
                            else
                            {
                                @("0h 0p")
                            }
                        }
                    </p>

                </div>
            </div>

            <p>
                <strong>Trạng thái:</strong>
                @if (Model.Trangthai == true)
                {
                    <span class="badge bg-success px-3 py-2">Hoàn thành</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark px-3 py-2">Đang xử lý</span>
                }
            </p>

        </div>
    </div>

    <!-- DANH SÁCH DỊCH VỤ -->
    <div class="card shadow-sm border-0">

        <div class="card-header bg-light fw-bold text-primary">
            <i class="bi bi-list-check me-1"></i> Danh sách dịch vụ
        </div>

        <div class="card-body p-0">
            <table class="table table-bordered table-hover mb-0">
                <thead class="table-light">
                    <tr class="text-center">
                        <th style="width: 50px;">#</th>
                        <th>Dịch vụ</th>
                        <th class="text-end" style="width: 120px;">Đơn giá</th>
                        <th class="text-center" style="width: 80px;">SL</th>
                        <th class="text-end" style="width: 150px;">Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int i = 1;
                    }
                    @foreach (var dv in Model.Hoadondvs)
                    {
                        var gia = dv.IddvNavigation?.Giatien ?? 0;
                        var sl = dv.Soluong ?? 0;
                        var tt = gia * sl;

                        <tr>
                            <td class="text-center">@i</td>
                            <td>@dv.IddvNavigation?.Tendv</td>
                            <td class="text-end">@gia.ToString("N0")</td>
                            <td class="text-center fw-bold">@sl</td>
                            <td class="text-end fw-bold text-success">@tt.ToString("N0")</td>
                        </tr>

                        i++;
                    }
                </tbody>
            </table>
        </div>

        <div class="card-footer bg-white text-end">
            <p class="mb-1">Tiền giờ: <b>@tienGio.ToString("N0") VNĐ</b></p>
            <p class="mb-1">Tiền dịch vụ: <b>@tongDv.ToString("N0") VNĐ</b></p>

            <h5 class="fw-bold text-success">
                Tổng cộng: @tongCong.ToString("N0") VNĐ
            </h5>
        </div>

    </div>

</div>

<div class="modal-footer">
    <button class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="bi bi-x-circle"></i> Đóng
    </button>
</div>
